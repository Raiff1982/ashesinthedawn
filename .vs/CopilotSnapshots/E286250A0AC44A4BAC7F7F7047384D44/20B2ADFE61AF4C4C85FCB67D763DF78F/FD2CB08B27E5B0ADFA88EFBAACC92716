/**
 * MIDI EDITOR
 * Main container that brings together all MIDI editing components
 * Piano roll editor with note editing capabilities
 */

import { useState, useEffect } from 'react';
import { Music } from 'lucide-react';
import { useDAW } from '../contexts/DAWContext';
import { getAudioEngine } from '../lib/audioEngine';
import { MIDISequence, MIDINote } from '../types/midi';
import { createEmptySequence } from '../lib/midiUtils';
import { PianoRoll } from './PianoRoll';
import { NoteControls } from './NoteControls';
import { QuantizeHumanize } from './QuantizeHumanize';
import { Tooltip } from './TooltipProvider';

export function MIDIEditor() {
  const { selectedTrack, updateTrack, currentTime, isPlaying } = useDAW();
  const [midiSequence, setMIDISequence] = useState<MIDISequence | null>(null);
  const [selectedNotes, setSelectedNotes] = useState<MIDINote[]>([]);
  const [zoom, setZoom] = useState<number>(100);
  const [quantizeValue, setQuantizeValue] = useState<number>(8);

  const audioEngine = getAudioEngine();

  // Load MIDI sequence when track changes
  useEffect(() => {
    if (selectedTrack && 'midiSequence' in selectedTrack && selectedTrack.midiSequence) {
      setMIDISequence(selectedTrack.midiSequence as MIDISequence);
      setSelectedNotes([]);
    } else {
      setMIDISequence(null);
    }
  }, [selectedTrack?.id]);

  // Trigger MIDI playback when isPlaying changes
  useEffect(() => {
    if (!midiSequence) return;

    if (isPlaying) {
      // Play the sequence
      audioEngine.playMIDISequence(
        midiSequence.notes,
        midiSequence.bpm
      );
      console.log('▶️ Playing MIDI sequence');
    } else {
      // Stop all playback (audio engine will handle this)
      console.log('⏹️ Stopped MIDI playback');
    }
  }, [isPlaying, midiSequence]);

  // Update MIDI sequence in DAW context
  const handleSequenceChange = (newSequence: MIDISequence) => {
    setMIDISequence(newSequence);
    if (selectedTrack) {
      updateTrack(selectedTrack.id, {
        ...selectedTrack,
        ...newSequence,  // Just pass the new sequence
      } as Parameters<typeof updateTrack>[1]);
    }
  };

  // Handle notes change
  const handleNotesChange = (notes: MIDINote[]) => {
    if (!midiSequence) return;

    const updated: MIDISequence = {
      ...midiSequence,
      notes,
    };
    handleSequenceChange(updated);

    // Update selected notes
    const updatedSelectedNotes = notes.filter(n =>
      selectedNotes.some(sn => sn.id === n.id)
    );
    setSelectedNotes(updatedSelectedNotes);
  };

  // Create new MIDI sequence
  const handleCreateSequence = () => {
    const newSequence = createEmptySequence(120, 16);
    handleSequenceChange(newSequence);
  };

  // Handle keyboard shortcuts
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if (!midiSequence) return;

      // Delete selected notes
      if ((e.key === 'Delete' || e.key === 'Backspace') && selectedNotes.length > 0) {
        e.preventDefault();
        const updatedNotes = midiSequence.notes.filter(
          n => !selectedNotes.some(sn => sn.id === n.id)
        );
        handleNotesChange(updatedNotes);
        setSelectedNotes([]);
      }

      // Zoom shortcuts
      if (e.key === '+' || e.key === '=') {
        e.preventDefault();
        setZoom(z => Math.min(z + 20, 400));
      }
      if (e.key === '-') {
        e.preventDefault();
        setZoom(z => Math.max(z - 20, 20));
      }
    };

    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [midiSequence, selectedNotes]);

  // Not playing instrument track
  if (!selectedTrack || selectedTrack.type !== 'instrument') {
    return (
      <div className="flex flex-col items-center justify-center h-full bg-gray-950 p-8">
        <Music className="w-12 h-12 text-gray-600 mb-4" />
        <h3 className="text-lg font-semibold text-gray-400 mb-2">MIDI Editor</h3>
        <p className="text-sm text-gray-500 text-center">
          Select an instrument track to create and edit MIDI sequences
        </p>
      </div>
    );
  }

  // No sequence yet
  if (!midiSequence) {
    return (
      <div className="flex flex-col items-center justify-center h-full bg-gray-950 p-8">
        <div className="mb-6 text-center">
          <Music className="w-16 h-16 text-gray-600 mx-auto mb-4" />
          <h3 className="text-xl font-semibold text-gray-300 mb-2">
            {selectedTrack.name}
          </h3>
          <p className="text-sm text-gray-500 mb-6">
            No MIDI sequence yet. Create one to start editing.
          </p>
        </div>
        <Tooltip content={{
            title: 'Create Sequence',
            description: 'Create a new MIDI sequence for this instrument track',
            category: 'tools'
          }}>
          <button
            onClick={handleCreateSequence}
            className="px-6 py-3 bg-blue-600 hover:bg-blue-700 active:bg-blue-800 rounded-lg font-medium text-white transition-colors"
          >
            Create MIDI Sequence
          </button>
        </Tooltip>
      </div>
    );
  }

  return (
    <div className="flex flex-col h-full bg-gray-950 overflow-hidden">
      {/* Header with controls */}
      <div className="bg-gray-900 border-b border-gray-700 p-3 flex justify-between items-center">
        <div className="flex items-center gap-3">
          <Music className="w-5 h-5 text-blue-400" />
          <span className="font-semibold text-gray-300">{midiSequence.name}</span>
          <span className="text-xs text-gray-500">
            {midiSequence.notes.length} note{midiSequence.notes.length !== 1 ? 's' : ''}
          </span>
        </div>

        {/* Zoom controls */}
        <div className="flex items-center gap-2">
          <Tooltip content={{
              title: 'Zoom Out',
              description: 'Decrease editor zoom level',
              category: 'tools',
              hotkey: '-'
            }}>
            <button
              onClick={() => setZoom(z => Math.max(z - 20, 20))}
              className="px-3 py-1 text-sm bg-gray-800 hover:bg-gray-700 rounded transition-colors text-gray-300"
            >
              −
            </button>
          </Tooltip>
          <span className="text-xs text-gray-500 min-w-12 text-center">{zoom}%</span>
          <Tooltip content={{
              title: 'Zoom In',
              description: 'Increase editor zoom level',
              category: 'tools',
              hotkey: '+'
            }}>
            <button
              onClick={() => setZoom(z => Math.min(z + 20, 400))}
              className="px-3 py-1 text-sm bg-gray-800 hover:bg-gray-700 rounded transition-colors text-gray-300"
            >
              +
            </button>
          </Tooltip>

          {/* Quantize selector */}
          <select
            value={quantizeValue}
            onChange={(e) => setQuantizeValue(parseInt(e.target.value))}
            className="px-2 py-1 text-xs bg-gray-800 hover:bg-gray-700 border border-gray-700 rounded transition-colors text-gray-300"
          >
            <option value={4}>1/4</option>
            <option value={8}>1/8</option>
            <option value={16}>1/16</option>
            <option value={32}>1/32</option>
          </select>
        </div>
      </div>

      {/* Main editor area */}
      <div className="flex flex-col flex-1 min-h-0 overflow-hidden">
        {/* Piano roll (takes up most space) */}
        <div className="flex-1 min-h-0 overflow-hidden">
          <PianoRoll
            sequence={midiSequence}
            onNotesChange={handleNotesChange}
            isPlaying={isPlaying}
            playheadPosition={currentTime}
            zoom={zoom}
            quantizeValue={quantizeValue}
          />
        </div>

        {/* Bottom controls panel (fixed height) */}
        <div className="h-48 overflow-y-auto bg-gray-850 border-t border-gray-700">
          {/* Note Controls */}
          <div className="border-b border-gray-700">
            <NoteControls
              selectedNotes={selectedNotes}
              onNotesChange={handleNotesChange}
            />
          </div>

          {/* Quantize & Humanize */}
          <div>
            <QuantizeHumanize
              notes={midiSequence.notes}
              onNotesChange={handleNotesChange}
              bpm={midiSequence.bpm}
            />
          </div>
        </div>
      </div>

      {/* Keyboard shortcuts hint */}
      <div className="bg-gray-900 border-t border-gray-700 px-4 py-2 text-xs text-gray-500">
        <span>Delete: remove note • +/−: zoom • Click grid: add note • Drag note: move/resize</span>
      </div>
    </div>
  );
}
