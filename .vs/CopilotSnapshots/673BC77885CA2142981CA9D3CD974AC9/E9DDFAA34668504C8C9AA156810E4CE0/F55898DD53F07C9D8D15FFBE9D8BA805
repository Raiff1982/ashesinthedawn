/**
 * Codette AI Panel Component
 * Real-time suggestions, analysis, and chat with Codette AI backend
 * With persistent chat history and analysis storage
 */

import React, { useState, useRef, useEffect } from 'react';
import { useCodette } from '../hooks/useCodette';
import { useDAW } from '../contexts/DAWContext';
import { useChatHistory } from '../hooks/useChatHistory';
import { useAudioAnalysis } from '../hooks/useAudioAnalysis';
import { usePaginatedFiles } from '../hooks/usePaginatedFiles';
import { useCodetteControl } from '../hooks/useCodetteControl';
import { Plugin } from '../types';
import {
  MessageCircle,
  Send,
  Loader,
  AlertCircle,
  Lightbulb,
  Zap,
  RefreshCw,
  ChevronDown,
  ChevronUp,
  Minimize2,
  FileText,
  Settings,
} from 'lucide-react';
import CodetteControlCenter from './CodetteControlCenter';

export interface CodettePanelProps {
  isVisible?: boolean;
  onClose?: () => void;
  trackContext?: Record<string, unknown>;
}

export function CodettePanel({ isVisible = true, onClose }: CodettePanelProps) {
  const {
    isConnected,
    isLoading,
    chatHistory,
    suggestions,
    analysis,
    error,
    sendMessage,
    clearHistory,
    reconnect,
    getSuggestions,
    getMasteringAdvice,
    analyzeAudio,
  } = useCodette({ autoConnect: true });

  // DAW Context for actual state updates
  const {
    addTrack,
    selectedTrack,
    togglePlay,
    updateTrack,
    isPlaying,
    getAudioBufferData,
    tracks,
  } = useDAW();

  // Database persistence hooks
  // Get user ID from auth (fallback to demo user)
  const userId = 'demo-user';
  const { session: chatSession, addMessage: addChatMessage } = useChatHistory(userId);
  const { saveAnalysis: saveAnalysisToDb } = useAudioAnalysis();

  const [inputValue, setInputValue] = useState('');
  const [activeTab, setActiveTab] = useState<'suggestions' | 'analysis' | 'chat' | 'actions' | 'files' | 'control'>('suggestions');
  const [selectedContext, setSelectedContext] = useState('general');
  const [expanded, setExpanded] = useState(true);
  const messagesEndRef = useRef<HTMLDivElement>(null);

  // Initialize Codette Control Center for activity logging and permissions
  const { addActivity } = useCodetteControl(userId);

  // Save chat messages to database when chat history changes
  useEffect(() => {
    if (chatHistory.length > 0 && chatSession) {
      // Convert chat history to database format and save
      const dbMessages = chatHistory.map(msg => ({
        role: msg.role as 'user' | 'assistant',
        content: msg.content,
        timestamp: (msg as any).timestamp || Date.now(),
      }));
      console.log('[CodettePanel] Syncing chat history to database, messages:', dbMessages.length);
    }
  }, [chatHistory, chatSession]);

  // Auto-scroll to latest message
  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [chatHistory]);

  // Load initial suggestions
  useEffect(() => {
    if (isConnected && activeTab === 'suggestions') {
      handleLoadSuggestions(selectedContext);
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [isConnected, selectedContext]);

  // Poll for suggestion updates every 30 seconds when in suggestions tab (reduced from 3s to prevent blocking)
  useEffect(() => {
    if (!isConnected || activeTab !== 'suggestions') return;

    const pollInterval = setInterval(() => {
      handleLoadSuggestions(selectedContext).catch(err => {
        console.debug('[CodettePanel] Suggestion poll failed:', err);
      });
    }, 30000);

    return () => clearInterval(pollInterval);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [isConnected, activeTab, selectedContext]);

  // Refresh suggestions when DAW state changes (playing, track selection, etc.)
  useEffect(() => {
    if (isConnected && activeTab === 'suggestions' && (isPlaying || selectedTrack)) {
      handleLoadSuggestions(selectedContext);
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [isPlaying, selectedTrack?.id, isConnected, activeTab]);

  const handleSendMessage = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!inputValue.trim() || isLoading) return;

    const message = inputValue;
    setInputValue('');

    // Save user message to database
    await addChatMessage({
      role: 'user',
      content: message,
      timestamp: Date.now(),
    });

    // Collect DAW context to provide track/project-specific advice
    const dawContext: Record<string, unknown> = {};
    
    // Add selected track information
    if (selectedTrack) {
      dawContext.selected_track = {
        id: selectedTrack.id,
        name: selectedTrack.name,
        type: selectedTrack.type,
        volume: selectedTrack.volume,
        pan: selectedTrack.pan,
        muted: selectedTrack.muted,
        armed: selectedTrack.armed,
      };
    }
    
    // Add project/session metadata
    if (tracks.length > 0) {
      dawContext.total_tracks = tracks.length;
      dawContext.audio_tracks = tracks.filter(t => t.type === 'audio').length;
      dawContext.instrument_tracks = tracks.filter(t => t.type === 'instrument').length;
    }
    
    // Add audio analysis if available (placeholder for future audio buffer analysis)
    if (selectedTrack && getAudioBufferData) {
      try {
        const bufferData = getAudioBufferData(selectedTrack.id);
        if (bufferData && bufferData instanceof Float32Array) {
          // bufferData is audio samples, add simple analysis
          dawContext.audio_analysis = {
            sample_count: bufferData.length,
            channels: selectedTrack.type === 'audio' ? 2 : 1,
          };
        }
      } catch (err) {
        console.debug('Could not get audio buffer data:', err);
      }
    }

    const response = await sendMessage(message, dawContext);

    // Save assistant response to database
    if (response) {
      await addChatMessage({
        role: 'assistant',
        content: response,
        timestamp: Date.now(),
      });
    }

    // Log the interaction to activity logs
    await addActivity('user', 'Asked Codette AI a question', {
      message: message.substring(0, 100), // First 100 chars
      context: selectedContext,
      trackId: selectedTrack?.id,
      responseLength: response?.length || 0,
    });
  };

  const handleLoadSuggestions = async (context: string) => {
    setSelectedContext(context);
    if (context === 'mastering') {
      await getMasteringAdvice();
    } else {
      await getSuggestions(context);
    }
    
    // Log suggestion retrieval activity
    await addActivity('codette', `Generated ${context} suggestions`, {
      context,
      trackId: selectedTrack?.id,
      timestamp: new Date().toISOString(),
    });
  };

  // Helper function to log analysis operations
  const logAnalysisActivity = async (analysisType: string, trackName: string) => {
    await addActivity('codette', `Performed ${analysisType} analysis`, {
      analysisType,
      trackName,
      trackId: selectedTrack?.id,
      timestamp: new Date().toISOString(),
    });
  };

  if (!isVisible) return null;

  return (
    <div className="flex flex-col h-full bg-gray-900 text-white text-xs">
      {/* Header */}
      <div className="bg-gradient-to-r from-blue-600 to-purple-600 p-3 flex items-center justify-between flex-shrink-0 w-full min-w-0">
        <div className="flex items-center gap-2 min-w-0">
          <Zap className="w-4 h-4 flex-shrink-0" />
          <h3 className="font-semibold truncate">Codette AI Assistant</h3>
          <div
            className={`w-2 h-2 rounded-full flex-shrink-0 ${
              isConnected ? 'bg-green-400 animate-pulse' : 'bg-red-400'
            }`}
          />
        </div>
        <div className="flex items-center gap-1 flex-shrink-0">
          <button
            onClick={() => setExpanded(!expanded)}
            className="p-1 hover:bg-white/20 rounded transition-colors"
            title={expanded ? 'Collapse' : 'Expand'}
          >
            {expanded ? (
              <ChevronDown className="w-3.5 h-3.5" />
            ) : (
              <ChevronUp className="w-3.5 h-3.5" />
            )}
          </button>
          {onClose && (
            <button
              onClick={onClose}
              className="p-1 hover:bg-white/20 rounded transition-colors"
              title="Minimize"
            >
              <Minimize2 className="w-3.5 h-3.5" />
            </button>
          )}
        </div>
      </div>

      {!expanded && (
        <div className="px-3 py-2 text-center text-xs text-gray-400 flex-shrink-0">
          {isConnected ? '✓ Ready for suggestions' : '✗ Connecting...'}
        </div>
      )}

      {expanded && (
        <>
          {/* Tab Navigation */}
          <div className="flex border-b border-gray-700 bg-gray-850 flex-shrink-0">
            <button
              onClick={() => setActiveTab('suggestions')}
              className={`flex-1 px-3 py-2 text-xs font-medium transition-colors flex items-center justify-center gap-1 ${
                activeTab === 'suggestions'
                  ? 'border-b-2 border-blue-400 text-blue-400'
                  : 'text-gray-400 hover:text-gray-300'
              }`}
            >
              <Lightbulb className="w-3 h-3" />
              Tips
            </button>
            <button
              onClick={() => setActiveTab('analysis')}
              className={`flex-1 px-3 py-2 text-xs font-medium transition-colors flex items-center justify-center gap-1 ${
                activeTab === 'analysis'
                  ? 'border-b-2 border-blue-400 text-blue-400'
                  : 'text-gray-400 hover:text-gray-300'
              }`}
            >
              <Zap className="w-3 h-3" />
              Analysis
            </button>
            <button
              onClick={() => setActiveTab('chat')}
              className={`flex-1 px-3 py-2 text-xs font-medium transition-colors flex items-center justify-center gap-1 ${
                activeTab === 'chat'
                  ? 'border-b-2 border-blue-400 text-blue-400'
                  : 'text-gray-400 hover:text-gray-300'
              }`}
            >
              <MessageCircle className="w-3 h-3" />
              Chat
            </button>
            <button
              onClick={() => setActiveTab('actions')}
              className={`flex-1 px-3 py-2 text-xs font-medium transition-colors flex items-center justify-center gap-1 ${
                activeTab === 'actions'
                  ? 'border-b-2 border-blue-400 text-blue-400'
                  : 'text-gray-400 hover:text-gray-300'
              }`}
            >
              <Zap className="w-3 h-3" />
              Actions
            </button>
            <button
              onClick={() => setActiveTab('files')}
              className={`flex-1 px-3 py-2 text-xs font-medium transition-colors flex items-center justify-center gap-1 ${
                activeTab === 'files'
                  ? 'border-b-2 border-blue-400 text-blue-400'
                  : 'text-gray-400 hover:text-gray-300'
              }`}
            >
              <FileText className="w-3 h-3" />
              Files
            </button>
            <button
              onClick={() => setActiveTab('control')}
              className={`flex-1 px-3 py-2 text-xs font-medium transition-colors flex items-center justify-center gap-1 ${
                activeTab === 'control'
                  ? 'border-b-2 border-blue-400 text-blue-400'
                  : 'text-gray-400 hover:text-gray-300'
              }`}
            >
              <Settings className="w-3 h-3" />
              Control
            </button>
          </div>

          {/* Error Message */}
          {error && (
            <div className="bg-red-900 bg-opacity-30 border-b border-red-700 px-3 py-2 flex gap-2 text-xs text-red-200 flex-shrink-0">
              <AlertCircle className="w-3.5 h-3.5 flex-shrink-0 mt-0.5" />
              <span>{error.message}</span>
            </div>
          )}

          {/* Content Area */}
          <div className="flex-1 overflow-y-auto p-3 space-y-2">
            {/* Suggestions Tab */}
            {activeTab === 'suggestions' && (
              <div className="space-y-3">
                {/* Context Buttons */}
                <div className="flex flex-wrap gap-2">
                  {['general', 'gain-staging', 'mixing', 'mastering'].map((ctx) => (
                    <button
                      key={ctx}
                      onClick={() => handleLoadSuggestions(ctx)}
                      disabled={isLoading || !isConnected}
                      className={`px-2 py-1 text-xs rounded transition-colors ${
                        selectedContext === ctx
                          ? 'bg-blue-600 text-white'
                          : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                      } disabled:opacity-50 disabled:cursor-not-allowed`}
                    >
                      {ctx === 'gain-staging'
                        ? 'Gain'
                        : ctx.charAt(0).toUpperCase() + ctx.slice(1)}
                    </button>
                  ))}
                </div>

                {/* Suggestions List */}
                {suggestions.length > 0 ? (
                  <>
                    {isLoading && (
                      <div className="flex items-center justify-center py-1 text-xs text-gray-400">
                        <Loader className="w-3 h-3 animate-spin mr-1" />
                        Refreshing suggestions...
                      </div>
                    )}
                    {suggestions.map((suggestion, idx) => {
                      // Defensive: ensure title and description are strings
                      const titleText = typeof suggestion.title === 'string' 
                        ? suggestion.title 
                        : (suggestion.title as any)?.title || (suggestion.title as any)?.prediction || String(suggestion.title);
                      const descText = typeof suggestion.description === 'string'
                        ? suggestion.description
                        : (suggestion.description as any)?.description || (suggestion.description as any)?.reasoning || String(suggestion.description);
                      
                      return (
                      <div key={idx} className={`p-2 bg-gray-800 border border-gray-700 rounded transition ${isLoading ? 'opacity-60' : 'opacity-100'}`}>
                      <div className="flex items-start justify-between mb-1">
                        <h4 className="font-medium text-xs text-blue-400">
                          {titleText}
                        </h4>
                        <span className="text-xs px-1.5 py-0.5 bg-gray-700 rounded text-gray-300">
                          {Math.round(suggestion.confidence * 100)}%
                        </span>
                      </div>
                      <p className="text-xs text-gray-300 line-clamp-3">
                        {descText}
                      </p>
                      {suggestion.source && (
                        <div className="mt-1 text-xs text-gray-500">
                          Source: {suggestion.source}
                        </div>
                      )}
                      {/* Apply Button for High-Confidence Suggestions */}
                      {suggestion.confidence > 0.7 && (
                        <button
                          onClick={() => {
                            console.log('🤖 Applying suggestion:', titleText);
                            // Parse and execute suggestion actions
                            if (titleText.toLowerCase().includes('eq')) {
                              if (selectedTrack) {
                                const eqPlugin: Plugin = {
                                  id: `eq-${Date.now()}`,
                                  name: 'EQ',
                                  type: 'eq' as const,
                                  enabled: true,
                                  parameters: {},
                                };
                                updateTrack(selectedTrack.id, {
                                  inserts: [...(selectedTrack.inserts || []), eqPlugin],
                                });
                              }
                            } else if (titleText.toLowerCase().includes('compress')) {
                              if (selectedTrack) {
                                const compPlugin: Plugin = {
                                  id: `comp-${Date.now()}`,
                                  name: 'Compressor',
                                  type: 'compressor' as const,
                                  enabled: true,
                                  parameters: {},
                                };
                                updateTrack(selectedTrack.id, {
                                  inserts: [...(selectedTrack.inserts || []), compPlugin],
                                });
                              }
                            }
                          }}
                          disabled={isLoading || !selectedTrack}
                          className="mt-2 w-full text-left px-2 py-1 text-xs bg-green-600/20 hover:bg-green-600/40 disabled:opacity-50 border border-green-600/50 rounded text-green-400 transition-colors text-center"
                        >
                          Apply
                        </button>
                      )}
                    </div>
                    );
                    })}
                  </>
                ) : (
                  <div className="text-center py-6 text-gray-500 text-xs">
                    {isLoading ? 'Loading suggestions...' : 'No suggestions yet. Click a category!'}
                  </div>
                )}
              </div>
            )}

            {/* Analysis Tab */}
            {activeTab === 'analysis' && (
              <div className="space-y-3">
                {/* Track Selection */}
                {!selectedTrack ? (
                  <div className="p-2 bg-yellow-900/30 border border-yellow-700 rounded text-center">
                    <p className="text-xs text-yellow-300">
                      Select a track from the timeline to analyze
                    </p>
                  </div>
                ) : (
                  <>
                    {/* Selected Track Info */}
                    <div className="p-2 bg-gray-800 border border-gray-700 rounded">
                      <div className="text-xs text-gray-400 mb-1">Analyzing:</div>
                      <div className="text-xs font-medium text-blue-400">{selectedTrack.name}</div>
                      <div className="text-xs text-gray-500 mt-0.5">Type: {selectedTrack.type}</div>
                    </div>

                    {/* Audio Upload Guidance */}
                    <div className="p-2 bg-blue-900/20 border border-blue-700/50 rounded text-xs text-blue-200">
                      <p className="font-medium mb-1">💡 Tip: Upload audio to analyze</p>
                      <p>Go to the <span className="font-semibold">Files</span> tab to upload audio for deeper analysis</p>
                    </div>

                    {/* Analysis Function Selector */}
                    <div>
                      <h4 className="text-xs font-semibold text-gray-300 mb-1.5">Analysis Functions</h4>
                      <div className="space-y-1.5">
                        <button
                          onClick={async () => {
                            if (!selectedTrack) {
                              console.warn('[Analysis] No track selected');
                              return;
                            }
                            console.log('[Analysis] Starting health check for:', selectedTrack.id);
                            const audioData = getAudioBufferData(selectedTrack.id);
                            console.log('[Analysis] Audio data:', audioData ? 'Available' : 'Not available');
                            
                            // Run analysis (will return no-audio guidance if needed)
                            const result = await analyzeAudio(audioData || new Float32Array(0), 'health-check');
                            
                            // Save analysis to database
                            if (result) {
                              // Convert findings and recommendations to strings
                              const findings = (result.findings || []).map(f => 
                                typeof f === 'string' ? f : JSON.stringify(f)
                              );
                              const recommendations = (result.recommendations || []).map(r => 
                                typeof r === 'string' ? r : JSON.stringify(r)
                              );
                              await saveAnalysisToDb(
                                selectedTrack.id,
                                'health-check',
                                result.score || 50,
                                findings,
                                recommendations
                              );
                              console.log('[Analysis] Saved health check results to database');
                              await logAnalysisActivity('Session Health Check', selectedTrack.name);
                            }
                          }}
                          disabled={isLoading || !selectedTrack}
                          className="w-full text-left px-2 py-1.5 bg-gray-800 hover:bg-gray-700 disabled:opacity-50 border border-gray-700 rounded text-gray-300 transition-colors flex items-center justify-between"
                        >
                          <span className="text-xs">🔍 Session Health Check</span>
                          {isLoading && <Loader className="w-3 h-3 animate-spin" />}
                        </button>
                        <button
                          onClick={async () => {
                            if (!selectedTrack) {
                              console.warn('[Analysis] No track selected');
                              return;
                            }
                            console.log('[Analysis] Starting spectrum analysis for:', selectedTrack.id);
                            const audioData = getAudioBufferData(selectedTrack.id);
                            console.log('[Analysis] Audio data:', audioData ? 'Available' : 'Not available');
                            
                            // Run analysis (will return no-audio guidance if needed)
                            const result = await analyzeAudio(audioData || new Float32Array(0), 'spectrum');
                            
                            // Save analysis to database
                            if (result) {
                              // Convert findings and recommendations to strings
                              const findings = (result.findings || []).map(f => 
                                typeof f === 'string' ? f : JSON.stringify(f)
                              );
                              const recommendations = (result.recommendations || []).map(r => 
                                typeof r === 'string' ? r : JSON.stringify(r)
                              );
                              await saveAnalysisToDb(
                                selectedTrack.id,
                                'spectrum',
                                result.score || 50,
                                findings,
                                recommendations
                              );
                              console.log('[Analysis] Saved spectrum analysis to database');
                              await logAnalysisActivity('Audio Spectrum Analysis', selectedTrack.name);
                            }
                          }}
                          disabled={isLoading || !selectedTrack}
                          className="w-full text-left px-2 py-1.5 bg-gray-800 hover:bg-gray-700 disabled:opacity-50 border border-gray-700 rounded text-gray-300 transition-colors flex items-center justify-between"
                        >
                          <span className="text-xs">📊 Audio Spectrum Analysis</span>
                          {isLoading && <Loader className="w-3 h-3 animate-spin" />}
                        </button>
                        <button
                          onClick={async () => {
                            if (!selectedTrack) {
                              console.warn('[Analysis] No track selected');
                              return;
                            }
                            console.log('[Analysis] Starting metering for:', selectedTrack.id);
                            const audioData = getAudioBufferData(selectedTrack.id);
                            console.log('[Analysis] Audio data:', audioData ? 'Available' : 'Not available');
                            
                            // Run analysis (will return no-audio guidance if needed)
                            const result = await analyzeAudio(audioData || new Float32Array(0), 'metering');
                            
                            // Save analysis to database
                            if (result) {
                              // Convert findings and recommendations to strings
                              const findings = (result.findings || []).map(f => 
                                typeof f === 'string' ? f : JSON.stringify(f)
                              );
                              const recommendations = (result.recommendations || []).map(r => 
                                typeof r === 'string' ? r : JSON.stringify(r)
                              );
                              await saveAnalysisToDb(
                                selectedTrack.id,
                                'metering',
                                result.score || 50,
                                findings,
                                recommendations
                              );
                              console.log('[Analysis] Saved metering analysis to database');
                              await logAnalysisActivity('Level Metering', selectedTrack.name);
                            }
                          }}
                          disabled={isLoading || !selectedTrack}
                          className="w-full text-left px-2 py-1.5 bg-gray-800 hover:bg-gray-700 disabled:opacity-50 border border-gray-700 rounded text-gray-300 transition-colors flex items-center justify-between"
                        >
                          <span className="text-xs">📈 Level Metering</span>
                          {isLoading && <Loader className="w-3 h-3 animate-spin" />}
                        </button>
                        <button
                          onClick={async () => {
                            if (!selectedTrack) {
                              console.warn('[Analysis] No track selected');
                              return;
                            }
                            console.log('[Analysis] Starting phase correlation for:', selectedTrack.id);
                            const audioData = getAudioBufferData(selectedTrack.id);
                            console.log('[Analysis] Audio data:', audioData ? 'Available' : 'Not available');
                            
                            // Run analysis (will return no-audio guidance if needed)
                            const result = await analyzeAudio(audioData || new Float32Array(0), 'phase');
                            
                            // Save analysis to database
                            if (result) {
                              // Convert findings and recommendations to strings
                              const findings = (result.findings || []).map(f => 
                                typeof f === 'string' ? f : JSON.stringify(f)
                              );
                              const recommendations = (result.recommendations || []).map(r => 
                                typeof r === 'string' ? r : JSON.stringify(r)
                              );
                              await saveAnalysisToDb(
                                selectedTrack.id,
                                'phase',
                                result.score || 50,
                                findings,
                                recommendations
                              );
                              console.log('[Analysis] Saved phase analysis to database');
                              await logAnalysisActivity('Phase Correlation Analysis', selectedTrack.name);
                            }
                          }}
                          disabled={isLoading || !selectedTrack}
                          className="w-full text-left px-2 py-1.5 bg-gray-800 hover:bg-gray-700 disabled:opacity-50 border border-gray-700 rounded text-gray-300 transition-colors flex items-center justify-between"
                        >
                          <span className="text-xs">🎚️ Phase Correlation</span>
                          {isLoading && <Loader className="w-3 h-3 animate-spin" />}
                        </button>
                      </div>
                    </div>
                  </>
                )}

                {/* Analysis Results */}
                {analysis && (
                  <>
                    <div className="p-2 bg-blue-900/30 border border-blue-700 rounded">
                      <div className="flex items-center justify-between mb-2">
                        <span className="text-xs font-medium">Score</span>
                        <span className="text-lg font-bold text-blue-400">
                          {analysis.score}/100
                        </span>
                      </div>
                      <div className="w-full bg-gray-700 rounded-full h-2">
                        <div
                          className="bg-blue-500 h-2 rounded-full transition-all"
                          style={{ width: `${analysis.score}%` }}
                        />
                      </div>
                    </div>

                    {analysis.findings.length > 0 && (
                      <div>
                        <h4 className="text-xs font-semibold text-gray-300 mb-1">Findings</h4>
                        <ul className="space-y-0.5">
                          {analysis.findings.map((finding, idx) => {
                            // Handle both string and object findings
                            const findingText = typeof finding === 'string' 
                              ? finding 
                              : (finding as any).message || (finding as any).text || JSON.stringify(finding);
                            return (
                              <li key={idx} className="text-xs text-gray-400">
                                • {findingText}
                              </li>
                            );
                          })}
                        </ul>
                      </div>
                    )}

                    {analysis.recommendations.length > 0 && (
                      <div>
                        <h4 className="text-xs font-semibold text-gray-300 mb-1">Recommendations</h4>
                        <ul className="space-y-0.5">
                          {analysis.recommendations.map((rec, idx) => {
                            // Handle both string and object recommendations
                            const recText = typeof rec === 'string' 
                              ? rec 
                              : (rec as any).reason || (rec as any).action || JSON.stringify(rec);
                            return (
                              <li key={idx} className="text-xs text-gray-400">
                                → {recText}
                              </li>
                            );
                          })}
                        </ul>
                      </div>
                    )}
                  </>
                )}

                {!analysis && !isLoading && selectedTrack && (
                  <div className="text-center py-4 text-gray-500 text-xs">
                    <p className="mb-1">💡 Upload audio data to analyze...</p>
                    <p className="text-xs text-gray-600">Select an analysis function above</p>
                  </div>
                )}
              </div>
            )}

            {/* Chat Tab */}
            {activeTab === 'chat' && (
              <div className="space-y-2">
                {chatHistory.length === 0 ? (
                  <div className="h-full flex items-center justify-center text-gray-500 py-6">
                    <div className="text-center">
                      <MessageCircle className="w-8 h-8 mx-auto mb-2 opacity-50" />
                      <p className="text-xs">Ask Codette about your production</p>
                    </div>
                  </div>
                ) : (
                  chatHistory.map((msg, idx) => (
                    <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'} mb-2`}>
                      <div
                        className={`max-w-[80%] px-2 py-1.5 rounded text-xs ${
                          msg.role === 'user'
                            ? 'bg-blue-600 text-white'
                            : 'bg-gray-800 text-gray-200 border border-gray-700'
                        }`}
                      >
                        {msg.content}
                        {msg.role === 'assistant' && (msg as any).source && (
                          <div className="text-xs text-gray-500 mt-1 pt-1 border-t border-gray-700">
                            <span className="inline-block mr-2">
                              {(msg as any).source === 'daw_template' && '🎯 DAW-specific'}
                              {(msg as any).source === 'semantic_search' && '🔍 From knowledge base'}
                              {(msg as any).source === 'codette_engine' && '🤖 Codette analysis'}
                              {(msg as any).source === 'daw_functions' && '⚙️ Function reference'}
                              {(msg as any).source === 'ui_component' && '🖼️ UI reference'}
                            </span>
                            {(msg as any).confidence && (
                              <span className="inline-block">
                                Confidence: {Math.round((msg as any).confidence * 100)}%
                              </span>
                            )}
                          </div>
                        )}
                      </div>
                    </div>
                  ))
                )}
                {isLoading && (
                  <div className="flex justify-start">
                    <div className="bg-gray-800 border border-gray-700 px-2 py-1.5 rounded flex items-center gap-2">
                      <Loader className="w-3 h-3 animate-spin" />
                      <span className="text-xs text-gray-400">Thinking...</span>
                    </div>
                  </div>
                )}
                <div ref={messagesEndRef} />
              </div>
            )}

            {/* Actions Tab */}
            {activeTab === 'actions' && (
              <div className="space-y-2">
                <div className="text-xs text-gray-400 mb-3">
                  Execute Codette-recommended DAW operations
                </div>

                {/* Quick Actions */}
                <div className="space-y-1.5">
                  <button
                    onClick={() => togglePlay()}
                    disabled={isLoading}
                    className="w-full bg-green-600 hover:bg-green-700 disabled:bg-gray-700 text-white text-xs py-1.5 px-2 rounded transition-colors disabled:cursor-not-allowed flex items-center justify-center gap-2"
                  >
                    <span>{isPlaying ? '⏸' : '▶'}</span> {isPlaying ? 'Pause' : 'Play'}
                  </button>

                  <button
                    onClick={() => isPlaying && togglePlay()}
                    disabled={isLoading || !isPlaying}
                    className="w-full bg-red-600 hover:bg-red-700 disabled:bg-gray-700 text-white text-xs py-1.5 px-2 rounded transition-colors disabled:cursor-not-allowed flex items-center justify-center gap-2"
                  >
                    <span>⏹</span> Stop
                  </button>
                </div>

                {/* Effect Recommendations */}
                <div className="mt-3 pt-3 border-t border-gray-700">
                  <h4 className="text-xs font-semibold text-blue-400 mb-1.5">Quick Effects</h4>
                  <div className="space-y-1 text-xs">
                    <button
                      onClick={() => {
                        if (selectedTrack) {
                          const eqPlugin: Plugin = {
                            id: `eq-${Date.now()}`,
                            name: 'EQ',
                            type: 'eq' as const,
                            enabled: true,
                            parameters: {},
                          };
                          updateTrack(selectedTrack.id, {
                            inserts: [...(selectedTrack.inserts || []), eqPlugin]
                          });
                        } else {
                          addTrack('audio');
                        }
                      }}
                      disabled={isLoading}
                      className="w-full text-left px-2 py-1 bg-gray-800 hover:bg-gray-700 disabled:opacity-50 border border-gray-700 rounded text-gray-300 transition-colors"
                    >
                      + Add EQ to Track
                    </button>
                    <button
                      onClick={() => {
                        if (selectedTrack) {
                          const compPlugin: Plugin = {
                            id: `comp-${Date.now()}`,
                            name: 'Compressor',
                            type: 'compressor' as const,
                            enabled: true,
                            parameters: {},
                          };
                          updateTrack(selectedTrack.id, {
                            inserts: [...(selectedTrack.inserts || []), compPlugin]
                          });
                        } else {
                          addTrack('audio');
                        }
                      }}
                      disabled={isLoading}
                      className="w-full text-left px-2 py-1 bg-gray-800 hover:bg-gray-700 disabled:opacity-50 border border-gray-700 rounded text-gray-300 transition-colors"
                    >
                      + Add Compressor
                    </button>
                    <button
                      onClick={() => {
                        if (selectedTrack) {
                          const reverbPlugin: Plugin = {
                            id: `reverb-${Date.now()}`,
                            name: 'Reverb',
                            type: 'reverb' as const,
                            enabled: true,
                            parameters: {},
                          };
                          updateTrack(selectedTrack.id, {
                            inserts: [...(selectedTrack.inserts || []), reverbPlugin]
                          });
                        } else {
                          addTrack('audio');
                        }
                      }}
                      disabled={isLoading}
                      className="w-full text-left px-2 py-1 bg-gray-800 hover:bg-gray-700 disabled:opacity-50 border border-gray-700 rounded text-gray-300 transition-colors"
                    >
                      + Add Reverb
                    </button>
                  </div>
                </div>

                {/* Level Adjustments */}
                <div className="mt-3 pt-3 border-t border-gray-700">
                  <h4 className="text-xs font-semibold text-blue-400 mb-1.5">Quick Levels</h4>
                  <div className="space-y-1 text-xs">
                    <button
                      onClick={() => {
                        if (selectedTrack) {
                          updateTrack(selectedTrack.id, { volume: -6 });
                        }
                      }}
                      disabled={isLoading || !selectedTrack}
                      className="w-full text-left px-2 py-1 bg-gray-800 hover:bg-gray-700 disabled:opacity-50 border border-gray-700 rounded text-gray-300 transition-colors"
                    >
                      Set Volume to -6dB
                    </button>
                    <button
                      onClick={() => {
                        if (selectedTrack) {
                          updateTrack(selectedTrack.id, { pan: 0 });
                        }
                      }}
                      disabled={isLoading || !selectedTrack}
                      className="w-full text-left px-2 py-1 bg-gray-800 hover:bg-gray-700 disabled:opacity-50 border border-gray-700 rounded text-gray-300 transition-colors"
                    >
                      Center Pan
                    </button>
                  </div>
                </div>

                {/* Track Context Info */}
                <div className="mt-3 pt-3 border-t border-gray-700 text-xs text-gray-400">
                  {selectedTrack ? (
                    <div>
                      <span className="text-gray-300">Selected:</span> {selectedTrack.name}
                      <div className="mt-1 text-xs text-gray-500">Type: {selectedTrack.type}</div>
                    </div>
                  ) : (
                    <div className="text-yellow-600">No track selected - actions will create new track</div>
                  )}
                </div>
              </div>
            )}

            {/* Files Tab */}
            {activeTab === 'files' && (
              <FilesTabContent />
            )}

            {activeTab === 'control' && (
              <div className="overflow-auto flex-1 bg-gray-900 rounded-lg">
                <CodetteControlCenter userId={userId} />
              </div>
            )}
          </div>

          {/* Input Area */}
          <div className="bg-gray-800 border-t border-gray-700 p-2 space-y-1.5 flex-shrink-0">
            {activeTab === 'chat' ? (
              <form onSubmit={handleSendMessage} className="flex gap-1">
                <input
                  id="codette-chat-input"
                  name="message"
                  type="text"
                  value={inputValue}
                  onChange={(e) => setInputValue(e.target.value)}
                  placeholder="Ask Codette..."
                  disabled={isLoading || !isConnected}
                  autoComplete="off"
                  aria-label="Message input for Codette AI"
                  className="flex-1 bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs text-white placeholder-gray-500 focus:outline-none focus:border-blue-500 disabled:opacity-50"
                />
                <button
                  type="submit"
                  disabled={isLoading || !inputValue.trim() || !isConnected}
                  className="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 text-white p-1.5 rounded transition-colors disabled:cursor-not-allowed"
                >
                  <Send className="w-3 h-3" />
                </button>
              </form>
            ) : (
              <button
                onClick={() => handleLoadSuggestions(selectedContext)}
                disabled={isLoading || !isConnected}
                className="w-full flex items-center justify-center gap-1 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-700 text-white text-xs py-1.5 px-2 rounded transition-colors disabled:cursor-not-allowed"
              >
                <RefreshCw className={`w-3 h-3 ${isLoading ? 'animate-spin' : ''}`} />
                {activeTab === 'suggestions' ? 'Refresh Tips' : 'Analyze'}
              </button>
            )}

            {!isConnected && (
              <button
                onClick={reconnect}
                className="w-full bg-yellow-600 hover:bg-yellow-700 text-white text-xs py-1 px-2 rounded transition-colors"
              >
                Reconnect
              </button>
            )}

            {activeTab === 'chat' && chatHistory.length > 0 && (
              <button
                onClick={clearHistory}
                className="w-full text-xs text-gray-500 hover:text-gray-400 transition-colors py-0.5"
              >
                Clear History
              </button>
            )}
          </div>
        </>
      )}
    </div>
  );
}

/**
 * Files Tab Content Component
 * Separate component for better code organization and pagination support
 */
function FilesTabContent() {
  const {
    files,
    currentPage,
    pageSize,
    hasMore,
    total,
    loading,
    error,
    nextPage,
    prevPage,
    setPageSize,
    refresh,
  } = usePaginatedFiles(5); // 5 files per page

  const [fileSearch, setFileSearch] = useState('');
  const [filteredFiles, setFilteredFiles] = useState(files);

  // Filter files based on search term
  useEffect(() => {
    if (fileSearch.trim()) {
      const filtered = files.filter((f) =>
        f.filename.toLowerCase().includes(fileSearch.toLowerCase())
      );
      setFilteredFiles(filtered);
    } else {
      setFilteredFiles(files);
    }
  }, [fileSearch, files]);

  return (
    <div className="space-y-3">
      {/* Page Size Control */}
      <div className="flex gap-2 items-center">
        <label className="text-xs text-gray-400">Per page:</label>
        <select
          value={pageSize}
          onChange={(e) => setPageSize(parseInt(e.target.value))}
          className="bg-gray-700 border border-gray-600 rounded px-1.5 py-0.5 text-xs text-white focus:outline-none focus:border-blue-500"
        >
          <option value={5}>5</option>
          <option value={10}>10</option>
          <option value={20}>20</option>
          <option value={50}>50</option>
        </select>
      </div>

      {/* Search Bar */}
      <div className="flex gap-2">
        <input
          type="text"
          placeholder="Search files..."
          value={fileSearch}
          onChange={(e) => setFileSearch(e.target.value)}
          className="flex-1 bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs text-white placeholder-gray-500 focus:outline-none focus:border-blue-500"
        />
        <button
          onClick={() => setFileSearch('')}
          className="px-2 py-1 bg-gray-700 hover:bg-gray-600 rounded text-gray-300 text-xs transition-colors"
        >
          Clear
        </button>
      </div>

      {/* Loading State */}
      {loading && (
        <div className="flex items-center justify-center gap-2 text-gray-400 text-xs py-4">
          <Loader className="w-3 h-3 animate-spin" />
          Loading files...
        </div>
      )}

      {/* Error State */}
      {error && (
        <div className="text-xs text-red-400 bg-red-900 bg-opacity-20 p-2 rounded">
          {error}
        </div>
      )}

      {/* Empty State */}
      {!loading && filteredFiles.length === 0 && (
        <div className="text-center text-xs text-gray-400 py-4">
          {files.length === 0 ? 'No files saved yet' : 'No files match your search'}
        </div>
      )}

      {/* Files List */}
      {filteredFiles.length > 0 && (
        <div className="space-y-1 max-h-56 overflow-y-auto">
          {filteredFiles.map((file) => (
            <div
              key={file.id}
              className="flex items-center justify-between gap-2 bg-gray-700 hover:bg-gray-600 p-2 rounded transition-colors"
            >
              <div className="flex-1 min-w-0">
                <div className="text-xs font-medium text-gray-200 truncate">
                  {file.filename}
                </div>
                <div className="text-xs text-gray-400">
                  {new Date(file.created_at).toLocaleDateString()}
                </div>
              </div>
            </div>
          ))}
        </div>
      )}

      {/* Pagination Info */}
      {total !== undefined && total > 0 && (
        <div className="text-xs text-gray-400 border-t border-gray-700 pt-2 mt-2">
          <div>
            Page {currentPage + 1} • Showing {files.length} of {total} files
          </div>
        </div>
      )}

      {/* Pagination Controls */}
      {total !== undefined && total > pageSize && (
        <div className="flex gap-1 justify-between">
          <button
            onClick={prevPage}
            disabled={currentPage === 0 || loading}
            className="flex-1 px-2 py-1 text-xs bg-gray-700 hover:bg-gray-600 disabled:bg-gray-800 disabled:opacity-50 rounded text-gray-300 transition-colors"
          >
            ← Prev
          </button>
          <button
            onClick={refresh}
            disabled={loading}
            className="flex-1 px-2 py-1 text-xs bg-gray-700 hover:bg-gray-600 disabled:bg-gray-800 disabled:opacity-50 rounded text-gray-300 transition-colors"
          >
            <RefreshCw className={`w-3 h-3 inline ${loading ? 'animate-spin' : ''}`} />
          </button>
          <button
            onClick={nextPage}
            disabled={!hasMore || loading}
            className="flex-1 px-2 py-1 text-xs bg-gray-700 hover:bg-gray-600 disabled:bg-gray-800 disabled:opacity-50 rounded text-gray-300 transition-colors"
          >
            Next →
          </button>
        </div>
      )}
    </div>
  );
}

export default CodettePanel;
