/**
 * Codette AI Panel Component
 * Real-time suggestions, analysis, and chat with Codette AI backend
 * With persistent chat history and analysis storage
 */

import React, { useState, useRef, useEffect } from 'react';
import { useCodette } from '@/hooks/useCodette';
import { useDAW } from '@/contexts/DAWContext';
import { useChatHistory } from '@/hooks/useChatHistory';
import { useAudioAnalysis } from '@/hooks/useAudioAnalysis';
import { usePaginatedFiles } from '@/hooks/usePaginatedFiles';
import { useCodetteControl } from '@/hooks/useCodetteControl';
import type { Plugin } from '@/types';
import {
  MessageCircle,
  Send,
  Loader,
  AlertCircle,
  Lightbulb,
  Zap,
  RefreshCw,
  ChevronDown,
  ChevronUp,
  Minimize2,
  FileText,
  Settings,
} from 'lucide-react';
import CodetteControlCenter from './CodetteControlCenter';

export interface CodettePanelProps {
  isVisible?: boolean;
  onClose?: () => void;
  trackContext?: Record<string, unknown>;
}

export function CodettePanel({ isVisible = true, onClose }: CodettePanelProps) {
  const {
    isConnected,
    isLoading,
    chatHistory,
    suggestions,
    analysis,
    error,
    sendMessage,
    clearHistory,
    reconnect,
    getSuggestions,
    getMasteringAdvice,
    analyzeAudio,
  } = useCodette({ autoConnect: true });

  // DAW Context for actual state updates
  const {
    addTrack,
    selectedTrack,
    togglePlay,
    updateTrack,
    isPlaying,
    getAudioBufferData,
    tracks,
  } = useDAW();

  // Database persistence hooks
  // Get user ID from auth (fallback to demo user)
  const userId = 'demo-user';
  const { session: chatSession, addMessage: addChatMessage } = useChatHistory(userId);
  const { saveAnalysis: saveAnalysisToDb } = useAudioAnalysis();

  const [inputValue, setInputValue] = useState('')
